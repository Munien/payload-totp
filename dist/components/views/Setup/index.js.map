{"version":3,"sources":["../../../../src/components/views/Setup/index.tsx"],"sourcesContent":["import type { I18nClient } from '@payloadcms/translations'\nimport type { AdminViewProps, ServerComponentProps } from 'payload'\n\nimport { MinimalTemplate } from '@payloadcms/next/templates'\nimport { formatAdminURL } from '@payloadcms/ui/shared'\nimport { redirect } from 'next/navigation.js'\nimport { Secret, TOTP } from 'otpauth'\n\nimport type { CustomTranslationsKeys, CustomTranslationsObject } from '../../../i18n/types.js'\nimport type { PayloadTOTPConfig, UserWithTotp } from '../../../types.js'\n\nimport QRCode from '../../QRCode/index.js'\nimport Form from './Form.js'\nimport styles from './index.module.css'\nimport ShowSecret from './ShowSecret/index.js'\n\ntype Args = {\n\tpluginOptions: PayloadTOTPConfig\n} & AdminViewProps &\n\tServerComponentProps\n\nexport const TOTPSetup: React.FC<Args> = (args) => {\n\tconst i18n = args.i18n as I18nClient<CustomTranslationsObject, CustomTranslationsKeys>\n\tconst {\n\t\tinitPageResult: {\n\t\t\treq: {\n\t\t\t\tpayload: {\n\t\t\t\t\tconfig: {\n\t\t\t\t\t\troutes: { admin: adminRoute, api: apiRoute },\n\t\t\t\t\t\tserverURL,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tuser: _user,\n\t\t\t},\n\t\t},\n\t\tpluginOptions,\n\t\tsearchParams: { back } = {},\n\t} = args\n\n\tconst user = _user as unknown as UserWithTotp\n\n\tif (!user) {\n\t\tconst url = formatAdminURL({\n\t\t\tadminRoute,\n\t\t\tpath: '/login',\n\t\t\tserverURL,\n\t\t})\n\n\t\tredirect(url)\n\t}\n\n\tif (user.hasTotp) {\n\t\tconst url = formatAdminURL({\n\t\t\tadminRoute,\n\t\t\tpath: '/',\n\t\t\tserverURL,\n\t\t})\n\n\t\tredirect(url)\n\t}\n\n\tconst secret = new Secret({\n\t\tsize: 32,\n\t})\n\n\tconst totp = new TOTP({\n\t\talgorithm: pluginOptions.totp?.algorithm || 'SHA1',\n\t\tdigits: pluginOptions.totp?.digits || 6,\n\t\tissuer: pluginOptions.totp?.issuer || 'Payload',\n\t\t// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n\t\t// @ts-ignore\n\t\tlabel: user.email || user.username,\n\t\tperiod: pluginOptions.totp?.period || 30,\n\t\tsecret,\n\t})\n\n\treturn (\n\t\t<MinimalTemplate className={styles.root}>\n\t\t\t<h1>{i18n.t('totpPlugin:setup:title')}</h1>\n\t\t\t<p\n\t\t\t\tdangerouslySetInnerHTML={{\n\t\t\t\t\t__html: i18n.t('totpPlugin:setup:description'),\n\t\t\t\t}}\n\t\t\t></p>\n\t\t\t<div className={styles.qr}>\n\t\t\t\t<QRCode\n\t\t\t\t\tforceWhiteBackgroundOnQrCode={pluginOptions.forceWhiteBackgroundOnQrCode}\n\t\t\t\t\ttotp={totp}\n\t\t\t\t/>\n\t\t\t\t<ShowSecret i18n={i18n} secret={secret.base32} />\n\t\t\t</div>\n\t\t\t<div className={styles.code}>\n\t\t\t\t<p>\n\t\t\t\t\t{i18n\n\t\t\t\t\t\t.t('totpPlugin:setup:enterCode')\n\t\t\t\t\t\t.replace('{digits}', (pluginOptions.totp?.digits || 6).toString())}\n\t\t\t\t</p>\n\t\t\t\t<Form\n\t\t\t\t\tapiRoute={apiRoute}\n\t\t\t\t\tback={(typeof back === 'string' && back) || undefined}\n\t\t\t\t\tlength={pluginOptions.totp?.digits}\n\t\t\t\t\tsecret={secret.base32}\n\t\t\t\t\tserverURL={serverURL}\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</MinimalTemplate>\n\t)\n}\n"],"names":["MinimalTemplate","formatAdminURL","redirect","Secret","TOTP","QRCode","Form","styles","ShowSecret","TOTPSetup","args","i18n","initPageResult","req","payload","config","routes","admin","adminRoute","api","apiRoute","serverURL","user","_user","pluginOptions","searchParams","back","url","path","hasTotp","secret","size","totp","algorithm","digits","issuer","label","email","username","period","className","root","h1","t","p","dangerouslySetInnerHTML","__html","div","qr","forceWhiteBackgroundOnQrCode","base32","code","replace","toString","undefined","length"],"mappings":";AAGA,SAASA,eAAe,QAAQ,6BAA4B;AAC5D,SAASC,cAAc,QAAQ,wBAAuB;AACtD,SAASC,QAAQ,QAAQ,qBAAoB;AAC7C,SAASC,MAAM,EAAEC,IAAI,QAAQ,UAAS;AAKtC,OAAOC,YAAY,wBAAuB;AAC1C,OAAOC,UAAU,YAAW;AAC5B,OAAOC,YAAY,qBAAoB;AACvC,OAAOC,gBAAgB,wBAAuB;AAO9C,OAAO,MAAMC,YAA4B,CAACC;IACzC,MAAMC,OAAOD,KAAKC,IAAI;IACtB,MAAM,EACLC,gBAAgB,EACfC,KAAK,EACJC,SAAS,EACRC,QAAQ,EACPC,QAAQ,EAAEC,OAAOC,UAAU,EAAEC,KAAKC,QAAQ,EAAE,EAC5CC,SAAS,EACT,EACD,EACDC,MAAMC,KAAK,EACX,EACD,EACDC,aAAa,EACbC,cAAc,EAAEC,IAAI,EAAE,GAAG,CAAC,CAAC,EAC3B,GAAGhB;IAEJ,MAAMY,OAAOC;IAEb,IAAI,CAACD,MAAM;QACV,MAAMK,MAAM1B,eAAe;YAC1BiB;YACAU,MAAM;YACNP;QACD;QAEAnB,SAASyB;IACV;IAEA,IAAIL,KAAKO,OAAO,EAAE;QACjB,MAAMF,MAAM1B,eAAe;YAC1BiB;YACAU,MAAM;YACNP;QACD;QAEAnB,SAASyB;IACV;IAEA,MAAMG,SAAS,IAAI3B,OAAO;QACzB4B,MAAM;IACP;IAEA,MAAMC,OAAO,IAAI5B,KAAK;QACrB6B,WAAWT,cAAcQ,IAAI,EAAEC,aAAa;QAC5CC,QAAQV,cAAcQ,IAAI,EAAEE,UAAU;QACtCC,QAAQX,cAAcQ,IAAI,EAAEG,UAAU;QACtC,6DAA6D;QAC7D,aAAa;QACbC,OAAOd,KAAKe,KAAK,IAAIf,KAAKgB,QAAQ;QAClCC,QAAQf,cAAcQ,IAAI,EAAEO,UAAU;QACtCT;IACD;IAEA,qBACC,MAAC9B;QAAgBwC,WAAWjC,OAAOkC,IAAI;;0BACtC,KAACC;0BAAI/B,KAAKgC,CAAC,CAAC;;0BACZ,KAACC;gBACAC,yBAAyB;oBACxBC,QAAQnC,KAAKgC,CAAC,CAAC;gBAChB;;0BAED,MAACI;gBAAIP,WAAWjC,OAAOyC,EAAE;;kCACxB,KAAC3C;wBACA4C,8BAA8BzB,cAAcyB,4BAA4B;wBACxEjB,MAAMA;;kCAEP,KAACxB;wBAAWG,MAAMA;wBAAMmB,QAAQA,OAAOoB,MAAM;;;;0BAE9C,MAACH;gBAAIP,WAAWjC,OAAO4C,IAAI;;kCAC1B,KAACP;kCACCjC,KACCgC,CAAC,CAAC,8BACFS,OAAO,CAAC,YAAY,AAAC5B,CAAAA,cAAcQ,IAAI,EAAEE,UAAU,CAAA,EAAGmB,QAAQ;;kCAEjE,KAAC/C;wBACAc,UAAUA;wBACVM,MAAM,AAAC,OAAOA,SAAS,YAAYA,QAAS4B;wBAC5CC,QAAQ/B,cAAcQ,IAAI,EAAEE;wBAC5BJ,QAAQA,OAAOoB,MAAM;wBACrB7B,WAAWA;;;;;;AAKhB,EAAC"}