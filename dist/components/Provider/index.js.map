{"version":3,"sources":["../../../src/components/Provider/index.tsx"],"sourcesContent":["import type { ServerComponentProps } from 'payload'\n\nimport { formatAdminURL } from '@payloadcms/ui/shared'\nimport { headers } from 'next/headers.js'\nimport { redirect } from 'next/navigation.js'\n\nimport type { PayloadTOTPConfig, UserWithTotp } from '../../types.js'\n\nimport TOTPProviderClient from './index.client.js'\n\ntype Args = {\n\tchildren: React.ReactNode\n\tpluginOptions: PayloadTOTPConfig\n} & ServerComponentProps\n\nexport const TOTPProvider = async (args: Args) => {\n\tconst { children, payload, pluginOptions, user: _user } = args\n\tconst user = _user as UserWithTotp\n\tconst headersList = await headers()\n\tconst pathname = headersList.get('x-pathname') || '/'\n\n\tconst verifyUrl = formatAdminURL({\n\t\tadminRoute: payload.config.routes.admin,\n\t\tpath: '/verify-totp',\n\t})\n\n\tconst setupUrl = formatAdminURL({\n\t\tadminRoute: payload.config.routes.admin,\n\t\tpath: '/setup-totp',\n\t})\n\n\tif (\n\t\tuser &&\n\t\tuser.hasTotp &&\n\t\t!['api-key', 'totp'].includes((user as any)._strategy) &&\n\t\tpathname !== verifyUrl\n\t) {\n\t\tredirect(`${payload.config.serverURL}${verifyUrl}?back=${encodeURIComponent(pathname)}`)\n\t} else if (\n\t\tuser &&\n\t\t!user.hasTotp &&\n\t\tpluginOptions.forceSetup &&\n\t\tpathname !== setupUrl &&\n\t\t(user as any)._strategy !== 'api-key'\n\t) {\n\t\tredirect(`${payload.config.serverURL}${setupUrl}?back=${encodeURIComponent(pathname)}`)\n\t} else {\n\t\treturn (\n\t\t\t<TOTPProviderClient\n\t\t\t\tforceSetup={pluginOptions.forceSetup}\n\t\t\t\tsetupUrl={setupUrl}\n\t\t\t\tverifyUrl={verifyUrl}\n\t\t\t>\n\t\t\t\t{children}\n\t\t\t</TOTPProviderClient>\n\t\t)\n\t}\n}\n"],"names":["formatAdminURL","headers","redirect","TOTPProviderClient","TOTPProvider","args","children","payload","pluginOptions","user","_user","headersList","pathname","get","verifyUrl","adminRoute","config","routes","admin","path","setupUrl","hasTotp","includes","_strategy","serverURL","encodeURIComponent","forceSetup"],"mappings":";AAEA,SAASA,cAAc,QAAQ,wBAAuB;AACtD,SAASC,OAAO,QAAQ,kBAAiB;AACzC,SAASC,QAAQ,QAAQ,qBAAoB;AAI7C,OAAOC,wBAAwB,oBAAmB;AAOlD,OAAO,MAAMC,eAAe,OAAOC;IAClC,MAAM,EAAEC,QAAQ,EAAEC,OAAO,EAAEC,aAAa,EAAEC,MAAMC,KAAK,EAAE,GAAGL;IAC1D,MAAMI,OAAOC;IACb,MAAMC,cAAc,MAAMV;IAC1B,MAAMW,WAAWD,YAAYE,GAAG,CAAC,iBAAiB;IAElD,MAAMC,YAAYd,eAAe;QAChCe,YAAYR,QAAQS,MAAM,CAACC,MAAM,CAACC,KAAK;QACvCC,MAAM;IACP;IAEA,MAAMC,WAAWpB,eAAe;QAC/Be,YAAYR,QAAQS,MAAM,CAACC,MAAM,CAACC,KAAK;QACvCC,MAAM;IACP;IAEA,IACCV,QACAA,KAAKY,OAAO,IACZ,CAAC;QAAC;QAAW;KAAO,CAACC,QAAQ,CAAC,AAACb,KAAac,SAAS,KACrDX,aAAaE,WACZ;QACDZ,SAAS,GAAGK,QAAQS,MAAM,CAACQ,SAAS,GAAGV,UAAU,MAAM,EAAEW,mBAAmBb,WAAW;IACxF,OAAO,IACNH,QACA,CAACA,KAAKY,OAAO,IACbb,cAAckB,UAAU,IACxBd,aAAaQ,YACb,AAACX,KAAac,SAAS,KAAK,WAC3B;QACDrB,SAAS,GAAGK,QAAQS,MAAM,CAACQ,SAAS,GAAGJ,SAAS,MAAM,EAAEK,mBAAmBb,WAAW;IACvF,OAAO;QACN,qBACC,KAACT;YACAuB,YAAYlB,cAAckB,UAAU;YACpCN,UAAUA;YACVN,WAAWA;sBAEVR;;IAGJ;AACD,EAAC"}