{"version":3,"sources":["../../src/api/remove.ts"],"sourcesContent":["import type { I18nClient } from '@payloadcms/translations'\nimport type { BasePayload, PayloadHandler } from 'payload'\n\nimport { Secret, TOTP } from 'otpauth'\n\nimport type { CustomTranslationsKeys, CustomTranslationsObject } from '../i18n/types.js'\nimport type { PayloadTOTPConfig, UserWithTotp } from '../types.js'\n\nimport { getTotpSecret } from '../utilities/getTotpSecret.js'\nimport { removeCookie } from '../utilities/removeCookie.js'\n\nexport function removeEndpointHandler(pluginOptions: PayloadTOTPConfig) {\n\tconst handler: PayloadHandler = async (req) => {\n\t\tconst { payload, user } = req as unknown as { payload: BasePayload; user: UserWithTotp }\n\t\tconst i18n = req.i18n as unknown as I18nClient<\n\t\t\tCustomTranslationsObject,\n\t\t\tCustomTranslationsKeys\n\t\t>\n\n\t\tif (!user) {\n\t\t\treturn Response.json({ message: i18n.t('error:unauthorized'), ok: false })\n\t\t}\n\n\t\tif (!user.hasTotp || pluginOptions.forceSetup) {\n\t\t\treturn Response.json({ message: i18n.t('error:unauthorized'), ok: false })\n\t\t}\n\n\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\tlet data: any\n\n\t\ttry {\n\t\t\tdata = req.json && (await req.json())\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars, no-empty\n\t\t} catch (err) {}\n\n\t\t// TODO: A better validation\n\t\tif (typeof data !== 'object' || typeof data['token'] !== 'string') {\n\t\t\treturn Response.json({ message: i18n.t('error:unspecific'), ok: false })\n\t\t}\n\n\t\tconst totpSecret = await getTotpSecret({\n\t\t\tcollection: pluginOptions.collection,\n\t\t\tpayload,\n\t\t\tuser,\n\t\t})\n\n\t\tconst totp = new TOTP({\n\t\t\talgorithm: pluginOptions.totp?.algorithm || 'SHA1',\n\t\t\tdigits: pluginOptions.totp?.digits || 6,\n\t\t\tissuer: pluginOptions.totp?.issuer || 'Payload',\n\t\t\t// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n\t\t\t// @ts-ignore\n\t\t\tlabel: user.email || user.username,\n\t\t\tperiod: pluginOptions.totp?.period || 30,\n\t\t\tsecret: Secret.fromBase32(totpSecret!),\n\t\t})\n\n\t\tconst delta = totp.validate({ token: data['token'].toString(), window: 1 })\n\n\t\tif (delta === null) {\n\t\t\treturn Response.json({ message: i18n.t('totpPlugin:setup:incorrectCode'), ok: false })\n\t\t}\n\n\t\tawait payload.update({\n\t\t\tid: user.id,\n\t\t\tcollection: user.collection,\n\t\t\tdata: {\n\t\t\t\ttotpSecret: null,\n\t\t\t},\n\t\t\toverrideAccess: true,\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t} as any) // TODO: Report this to Payload\n\n\t\tawait removeCookie(payload.config.cookiePrefix)\n\n\t\treturn Response.json({ ok: true })\n\t}\n\n\treturn handler\n}\n\nexport interface IResponse {\n\tmessage?: string\n\tok: boolean\n}\n"],"names":["Secret","TOTP","getTotpSecret","removeCookie","removeEndpointHandler","pluginOptions","handler","req","payload","user","i18n","Response","json","message","t","ok","hasTotp","forceSetup","data","err","totpSecret","collection","totp","algorithm","digits","issuer","label","email","username","period","secret","fromBase32","delta","validate","token","toString","window","update","id","overrideAccess","config","cookiePrefix"],"mappings":"AAGA,SAASA,MAAM,EAAEC,IAAI,QAAQ,UAAS;AAKtC,SAASC,aAAa,QAAQ,gCAA+B;AAC7D,SAASC,YAAY,QAAQ,+BAA8B;AAE3D,OAAO,SAASC,sBAAsBC,aAAgC;IACrE,MAAMC,UAA0B,OAAOC;QACtC,MAAM,EAAEC,OAAO,EAAEC,IAAI,EAAE,GAAGF;QAC1B,MAAMG,OAAOH,IAAIG,IAAI;QAKrB,IAAI,CAACD,MAAM;YACV,OAAOE,SAASC,IAAI,CAAC;gBAAEC,SAASH,KAAKI,CAAC,CAAC;gBAAuBC,IAAI;YAAM;QACzE;QAEA,IAAI,CAACN,KAAKO,OAAO,IAAIX,cAAcY,UAAU,EAAE;YAC9C,OAAON,SAASC,IAAI,CAAC;gBAAEC,SAASH,KAAKI,CAAC,CAAC;gBAAuBC,IAAI;YAAM;QACzE;QAEA,8DAA8D;QAC9D,IAAIG;QAEJ,IAAI;YACHA,OAAOX,IAAIK,IAAI,IAAK,MAAML,IAAIK,IAAI;QAClC,uEAAuE;QACxE,EAAE,OAAOO,KAAK,CAAC;QAEf,4BAA4B;QAC5B,IAAI,OAAOD,SAAS,YAAY,OAAOA,IAAI,CAAC,QAAQ,KAAK,UAAU;YAClE,OAAOP,SAASC,IAAI,CAAC;gBAAEC,SAASH,KAAKI,CAAC,CAAC;gBAAqBC,IAAI;YAAM;QACvE;QAEA,MAAMK,aAAa,MAAMlB,cAAc;YACtCmB,YAAYhB,cAAcgB,UAAU;YACpCb;YACAC;QACD;QAEA,MAAMa,OAAO,IAAIrB,KAAK;YACrBsB,WAAWlB,cAAciB,IAAI,EAAEC,aAAa;YAC5CC,QAAQnB,cAAciB,IAAI,EAAEE,UAAU;YACtCC,QAAQpB,cAAciB,IAAI,EAAEG,UAAU;YACtC,6DAA6D;YAC7D,aAAa;YACbC,OAAOjB,KAAKkB,KAAK,IAAIlB,KAAKmB,QAAQ;YAClCC,QAAQxB,cAAciB,IAAI,EAAEO,UAAU;YACtCC,QAAQ9B,OAAO+B,UAAU,CAACX;QAC3B;QAEA,MAAMY,QAAQV,KAAKW,QAAQ,CAAC;YAAEC,OAAOhB,IAAI,CAAC,QAAQ,CAACiB,QAAQ;YAAIC,QAAQ;QAAE;QAEzE,IAAIJ,UAAU,MAAM;YACnB,OAAOrB,SAASC,IAAI,CAAC;gBAAEC,SAASH,KAAKI,CAAC,CAAC;gBAAmCC,IAAI;YAAM;QACrF;QAEA,MAAMP,QAAQ6B,MAAM,CAAC;YACpBC,IAAI7B,KAAK6B,EAAE;YACXjB,YAAYZ,KAAKY,UAAU;YAC3BH,MAAM;gBACLE,YAAY;YACb;YACAmB,gBAAgB;QAEjB,GAAU,+BAA+B;;QAEzC,MAAMpC,aAAaK,QAAQgC,MAAM,CAACC,YAAY;QAE9C,OAAO9B,SAASC,IAAI,CAAC;YAAEG,IAAI;QAAK;IACjC;IAEA,OAAOT;AACR"}