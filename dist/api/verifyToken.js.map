{"version":3,"sources":["../../src/api/verifyToken.ts"],"sourcesContent":["import type { I18nClient } from '@payloadcms/translations'\nimport type { BasePayload, PayloadHandler } from 'payload'\n\nimport { Secret, TOTP } from 'otpauth'\n\nimport type { CustomTranslationsKeys, CustomTranslationsObject } from '../i18n/types.js'\nimport type { PayloadTOTPConfig, UserWithTotp } from '../types.js'\n\nimport { setCookie } from '../setCookie.js'\nimport { getTotpSecret } from '../utilities/getTotpSecret.js'\n\nexport function verifyToken(pluginOptions: PayloadTOTPConfig) {\n\tconst handler: PayloadHandler = async (req) => {\n\t\tconst { payload, user } = req as unknown as {\n\t\t\tpayload: BasePayload\n\t\t\tuser: UserWithTotp\n\t\t}\n\t\tconst i18n = req.i18n as unknown as I18nClient<\n\t\t\tCustomTranslationsObject,\n\t\t\tCustomTranslationsKeys\n\t\t>\n\n\t\tif (!user) {\n\t\t\treturn Response.json({ message: i18n.t('error:unauthorized'), ok: false })\n\t\t}\n\n\t\tif (!user.hasTotp) {\n\t\t\treturn Response.json({ message: i18n.t('error:unauthorized'), ok: false })\n\t\t}\n\n\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\tlet data: any\n\n\t\ttry {\n\t\t\tdata = req.json && (await req.json())\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars, no-empty\n\t\t} catch (err) {}\n\n\t\tif (typeof data !== 'object' || typeof data['token'] !== 'string') {\n\t\t\treturn Response.json({ message: i18n.t('error:unspecific'), ok: false })\n\t\t}\n\n\t\tconst totpSecret = await getTotpSecret({\n\t\t\tcollection: pluginOptions.collection,\n\t\t\tpayload,\n\t\t\tuser,\n\t\t})\n\n\t\tconst totp = new TOTP({\n\t\t\talgorithm: pluginOptions.totp?.algorithm || 'SHA1',\n\t\t\tdigits: pluginOptions.totp?.digits || 6,\n\t\t\tissuer: pluginOptions.totp?.issuer || 'Payload',\n\t\t\t// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n\t\t\t// @ts-ignore\n\t\t\tlabel: user.email || user.username,\n\t\t\tperiod: pluginOptions.totp?.period || 30,\n\t\t\tsecret: Secret.fromBase32(totpSecret!),\n\t\t})\n\n\t\tconst delta = totp.validate({ token: data['token'].toString(), window: 1 })\n\n\t\tif (delta === null) {\n\t\t\treturn Response.json({ message: i18n.t('totpPlugin:setup:incorrectCode'), ok: false })\n\t\t}\n\n\t\tconst collection = payload.collections[pluginOptions.collection]\n\n\t\tawait setCookie({\n\t\t\tauthConfig: collection.config.auth,\n\t\t\tcookiePrefix: payload.config.cookiePrefix,\n\t\t\tsecret: payload.secret,\n\t\t\tuser,\n\t\t})\n\n\t\treturn Response.json({ ok: true })\n\t}\n\n\treturn handler\n}\n\nexport interface IResponse {\n\tmessage?: string\n\tok: boolean\n}\n"],"names":["Secret","TOTP","setCookie","getTotpSecret","verifyToken","pluginOptions","handler","req","payload","user","i18n","Response","json","message","t","ok","hasTotp","data","err","totpSecret","collection","totp","algorithm","digits","issuer","label","email","username","period","secret","fromBase32","delta","validate","token","toString","window","collections","authConfig","config","auth","cookiePrefix"],"mappings":"AAGA,SAASA,MAAM,EAAEC,IAAI,QAAQ,UAAS;AAKtC,SAASC,SAAS,QAAQ,kBAAiB;AAC3C,SAASC,aAAa,QAAQ,gCAA+B;AAE7D,OAAO,SAASC,YAAYC,aAAgC;IAC3D,MAAMC,UAA0B,OAAOC;QACtC,MAAM,EAAEC,OAAO,EAAEC,IAAI,EAAE,GAAGF;QAI1B,MAAMG,OAAOH,IAAIG,IAAI;QAKrB,IAAI,CAACD,MAAM;YACV,OAAOE,SAASC,IAAI,CAAC;gBAAEC,SAASH,KAAKI,CAAC,CAAC;gBAAuBC,IAAI;YAAM;QACzE;QAEA,IAAI,CAACN,KAAKO,OAAO,EAAE;YAClB,OAAOL,SAASC,IAAI,CAAC;gBAAEC,SAASH,KAAKI,CAAC,CAAC;gBAAuBC,IAAI;YAAM;QACzE;QAEA,8DAA8D;QAC9D,IAAIE;QAEJ,IAAI;YACHA,OAAOV,IAAIK,IAAI,IAAK,MAAML,IAAIK,IAAI;QAClC,uEAAuE;QACxE,EAAE,OAAOM,KAAK,CAAC;QAEf,IAAI,OAAOD,SAAS,YAAY,OAAOA,IAAI,CAAC,QAAQ,KAAK,UAAU;YAClE,OAAON,SAASC,IAAI,CAAC;gBAAEC,SAASH,KAAKI,CAAC,CAAC;gBAAqBC,IAAI;YAAM;QACvE;QAEA,MAAMI,aAAa,MAAMhB,cAAc;YACtCiB,YAAYf,cAAce,UAAU;YACpCZ;YACAC;QACD;QAEA,MAAMY,OAAO,IAAIpB,KAAK;YACrBqB,WAAWjB,cAAcgB,IAAI,EAAEC,aAAa;YAC5CC,QAAQlB,cAAcgB,IAAI,EAAEE,UAAU;YACtCC,QAAQnB,cAAcgB,IAAI,EAAEG,UAAU;YACtC,6DAA6D;YAC7D,aAAa;YACbC,OAAOhB,KAAKiB,KAAK,IAAIjB,KAAKkB,QAAQ;YAClCC,QAAQvB,cAAcgB,IAAI,EAAEO,UAAU;YACtCC,QAAQ7B,OAAO8B,UAAU,CAACX;QAC3B;QAEA,MAAMY,QAAQV,KAAKW,QAAQ,CAAC;YAAEC,OAAOhB,IAAI,CAAC,QAAQ,CAACiB,QAAQ;YAAIC,QAAQ;QAAE;QAEzE,IAAIJ,UAAU,MAAM;YACnB,OAAOpB,SAASC,IAAI,CAAC;gBAAEC,SAASH,KAAKI,CAAC,CAAC;gBAAmCC,IAAI;YAAM;QACrF;QAEA,MAAMK,aAAaZ,QAAQ4B,WAAW,CAAC/B,cAAce,UAAU,CAAC;QAEhE,MAAMlB,UAAU;YACfmC,YAAYjB,WAAWkB,MAAM,CAACC,IAAI;YAClCC,cAAchC,QAAQ8B,MAAM,CAACE,YAAY;YACzCX,QAAQrB,QAAQqB,MAAM;YACtBpB;QACD;QAEA,OAAOE,SAASC,IAAI,CAAC;YAAEG,IAAI;QAAK;IACjC;IAEA,OAAOT;AACR"}