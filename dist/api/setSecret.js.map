{"version":3,"sources":["../../src/api/setSecret.ts"],"sourcesContent":["import type { I18nClient } from '@payloadcms/translations'\nimport type { BasePayload, PayloadHandler } from 'payload'\n\nimport { Secret, TOTP } from 'otpauth'\n\nimport type { CustomTranslationsKeys, CustomTranslationsObject } from '../i18n/types.js'\nimport type { PayloadTOTPConfig, UserWithTotp } from '../types.js'\n\nimport { setCookie } from '../setCookie.js'\n\nexport function setSecret(pluginOptions: PayloadTOTPConfig) {\n\tconst handler: PayloadHandler = async (req) => {\n\t\tconst { payload, user } = req as unknown as {\n\t\t\tpayload: BasePayload\n\t\t\tuser: UserWithTotp\n\t\t}\n\t\tconst i18n = req.i18n as unknown as I18nClient<\n\t\t\tCustomTranslationsObject,\n\t\t\tCustomTranslationsKeys\n\t\t>\n\n\t\tif (!user) {\n\t\t\treturn Response.json({ message: i18n.t('error:unauthorized'), ok: false })\n\t\t}\n\n\t\tif (user.hasTotp) {\n\t\t\treturn Response.json({ message: i18n.t('totpPlugin:errors:alreadySet'), ok: false })\n\t\t}\n\n\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\tlet data: any\n\n\t\ttry {\n\t\t\tdata = req.json && (await req.json())\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars, no-empty\n\t\t} catch (err) {}\n\n\t\t// TODO: Better validation\n\t\tif (\n\t\t\ttypeof data !== 'object' ||\n\t\t\ttypeof data['token'] !== 'string' ||\n\t\t\ttypeof data['secret'] !== 'string'\n\t\t) {\n\t\t\treturn Response.json({ message: i18n.t('error:unspecific'), ok: false })\n\t\t}\n\n\t\tconst totp = new TOTP({\n\t\t\talgorithm: pluginOptions.totp?.algorithm || 'SHA1',\n\t\t\tdigits: pluginOptions.totp?.digits || 6,\n\t\t\tissuer: pluginOptions.totp?.issuer || 'Payload',\n\t\t\t// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n\t\t\t// @ts-ignore\n\t\t\tlabel: user.email || user.username,\n\t\t\tperiod: pluginOptions.totp?.period || 30,\n\t\t\tsecret: Secret.fromBase32(data['secret']),\n\t\t})\n\n\t\tconst delta = totp.validate({ token: data['token'].toString(), window: 1 })\n\n\t\tif (delta === null) {\n\t\t\treturn Response.json({ message: i18n.t('totpPlugin:setup:incorrectCode'), ok: false })\n\t\t}\n\n\t\tawait payload.update({\n\t\t\tid: user.id,\n\t\t\tcollection: pluginOptions.collection,\n\t\t\tdata: {\n\t\t\t\ttotpSecret: data['secret'],\n\t\t\t},\n\t\t\toverrideAccess: true,\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-explicit-any\n\t\t} as any) // TODO: Report this to Payload\n\n\t\tconst collection = payload.collections[pluginOptions.collection]\n\n\t\tawait setCookie({\n\t\t\tauthConfig: collection.config.auth,\n\t\t\tcookiePrefix: payload.config.cookiePrefix,\n\t\t\tsecret: payload.secret,\n\t\t\tuser,\n\t\t})\n\n\t\treturn Response.json({ ok: true })\n\t}\n\n\treturn handler\n}\n\nexport interface IResponse {\n\tmessage?: string\n\tok: boolean\n}\n"],"names":["Secret","TOTP","setCookie","setSecret","pluginOptions","handler","req","payload","user","i18n","Response","json","message","t","ok","hasTotp","data","err","totp","algorithm","digits","issuer","label","email","username","period","secret","fromBase32","delta","validate","token","toString","window","update","id","collection","totpSecret","overrideAccess","collections","authConfig","config","auth","cookiePrefix"],"mappings":"AAGA,SAASA,MAAM,EAAEC,IAAI,QAAQ,UAAS;AAKtC,SAASC,SAAS,QAAQ,kBAAiB;AAE3C,OAAO,SAASC,UAAUC,aAAgC;IACzD,MAAMC,UAA0B,OAAOC;QACtC,MAAM,EAAEC,OAAO,EAAEC,IAAI,EAAE,GAAGF;QAI1B,MAAMG,OAAOH,IAAIG,IAAI;QAKrB,IAAI,CAACD,MAAM;YACV,OAAOE,SAASC,IAAI,CAAC;gBAAEC,SAASH,KAAKI,CAAC,CAAC;gBAAuBC,IAAI;YAAM;QACzE;QAEA,IAAIN,KAAKO,OAAO,EAAE;YACjB,OAAOL,SAASC,IAAI,CAAC;gBAAEC,SAASH,KAAKI,CAAC,CAAC;gBAAiCC,IAAI;YAAM;QACnF;QAEA,8DAA8D;QAC9D,IAAIE;QAEJ,IAAI;YACHA,OAAOV,IAAIK,IAAI,IAAK,MAAML,IAAIK,IAAI;QAClC,uEAAuE;QACxE,EAAE,OAAOM,KAAK,CAAC;QAEf,0BAA0B;QAC1B,IACC,OAAOD,SAAS,YAChB,OAAOA,IAAI,CAAC,QAAQ,KAAK,YACzB,OAAOA,IAAI,CAAC,SAAS,KAAK,UACzB;YACD,OAAON,SAASC,IAAI,CAAC;gBAAEC,SAASH,KAAKI,CAAC,CAAC;gBAAqBC,IAAI;YAAM;QACvE;QAEA,MAAMI,OAAO,IAAIjB,KAAK;YACrBkB,WAAWf,cAAcc,IAAI,EAAEC,aAAa;YAC5CC,QAAQhB,cAAcc,IAAI,EAAEE,UAAU;YACtCC,QAAQjB,cAAcc,IAAI,EAAEG,UAAU;YACtC,6DAA6D;YAC7D,aAAa;YACbC,OAAOd,KAAKe,KAAK,IAAIf,KAAKgB,QAAQ;YAClCC,QAAQrB,cAAcc,IAAI,EAAEO,UAAU;YACtCC,QAAQ1B,OAAO2B,UAAU,CAACX,IAAI,CAAC,SAAS;QACzC;QAEA,MAAMY,QAAQV,KAAKW,QAAQ,CAAC;YAAEC,OAAOd,IAAI,CAAC,QAAQ,CAACe,QAAQ;YAAIC,QAAQ;QAAE;QAEzE,IAAIJ,UAAU,MAAM;YACnB,OAAOlB,SAASC,IAAI,CAAC;gBAAEC,SAASH,KAAKI,CAAC,CAAC;gBAAmCC,IAAI;YAAM;QACrF;QAEA,MAAMP,QAAQ0B,MAAM,CAAC;YACpBC,IAAI1B,KAAK0B,EAAE;YACXC,YAAY/B,cAAc+B,UAAU;YACpCnB,MAAM;gBACLoB,YAAYpB,IAAI,CAAC,SAAS;YAC3B;YACAqB,gBAAgB;QAEjB,GAAU,+BAA+B;;QAEzC,MAAMF,aAAa5B,QAAQ+B,WAAW,CAAClC,cAAc+B,UAAU,CAAC;QAEhE,MAAMjC,UAAU;YACfqC,YAAYJ,WAAWK,MAAM,CAACC,IAAI;YAClCC,cAAcnC,QAAQiC,MAAM,CAACE,YAAY;YACzChB,QAAQnB,QAAQmB,MAAM;YACtBlB;QACD;QAEA,OAAOE,SAASC,IAAI,CAAC;YAAEG,IAAI;QAAK;IACjC;IAEA,OAAOT;AACR"}