{"version":3,"sources":["../src/strategy.ts"],"sourcesContent":["import type { AuthStrategy } from 'payload'\n\nimport jwt from 'jsonwebtoken'\nimport { cookies } from 'next/headers.js'\n\nexport const strategy: AuthStrategy = {\n\tname: 'totp',\n\tauthenticate: async (args) => {\n\t\tconst { payload } = args\n\t\tconst cookieStore = await cookies()\n\t\tconst token = cookieStore.get(`${payload.config.cookiePrefix}-totp`)\n\n\t\tif (!token) {\n\t\t\treturn {\n\t\t\t\tuser: null,\n\t\t\t}\n\t\t}\n\n\t\tlet userId: string\n\t\tlet originalStrategyName: string\n\n\t\ttry {\n\t\t\tconst result = jwt.verify(token.value, payload.secret) as {\n\t\t\t\toriginalStrategy: string\n\t\t\t\tuserId: string\n\t\t\t}\n\n\t\t\tuserId = result.userId\n\t\t\toriginalStrategyName = result.originalStrategy\n\t\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\t} catch (err) {\n\t\t\t// TODO: Log it\n\t\t\treturn {\n\t\t\t\tuser: null,\n\t\t\t}\n\t\t}\n\n\t\tconst originalStrategy = payload.authStrategies.find(\n\t\t\t(strategy) => strategy.name === originalStrategyName,\n\t\t)\n\n\t\tif (!originalStrategy) {\n\t\t\treturn {\n\t\t\t\tuser: null,\n\t\t\t}\n\t\t}\n\n\t\tconst originalStrategyResult = await originalStrategy.authenticate(args)\n\n\t\tif (originalStrategyResult.user?.id === userId) {\n\t\t\treturn {\n\t\t\t\tuser: {\n\t\t\t\t\t...originalStrategyResult.user,\n\t\t\t\t\t_strategy: 'totp',\n\t\t\t\t},\n\t\t\t}\n\t\t} else {\n\t\t\treturn {\n\t\t\t\tuser: null,\n\t\t\t}\n\t\t}\n\t},\n}\n"],"names":["jwt","cookies","strategy","name","authenticate","args","payload","cookieStore","token","get","config","cookiePrefix","user","userId","originalStrategyName","result","verify","value","secret","originalStrategy","err","authStrategies","find","originalStrategyResult","id","_strategy"],"mappings":"AAEA,OAAOA,SAAS,eAAc;AAC9B,SAASC,OAAO,QAAQ,kBAAiB;AAEzC,OAAO,MAAMC,WAAyB;IACrCC,MAAM;IACNC,cAAc,OAAOC;QACpB,MAAM,EAAEC,OAAO,EAAE,GAAGD;QACpB,MAAME,cAAc,MAAMN;QAC1B,MAAMO,QAAQD,YAAYE,GAAG,CAAC,GAAGH,QAAQI,MAAM,CAACC,YAAY,CAAC,KAAK,CAAC;QAEnE,IAAI,CAACH,OAAO;YACX,OAAO;gBACNI,MAAM;YACP;QACD;QAEA,IAAIC;QACJ,IAAIC;QAEJ,IAAI;YACH,MAAMC,SAASf,IAAIgB,MAAM,CAACR,MAAMS,KAAK,EAAEX,QAAQY,MAAM;YAKrDL,SAASE,OAAOF,MAAM;YACtBC,uBAAuBC,OAAOI,gBAAgB;QAC9C,6DAA6D;QAC9D,EAAE,OAAOC,KAAK;YACb,eAAe;YACf,OAAO;gBACNR,MAAM;YACP;QACD;QAEA,MAAMO,mBAAmBb,QAAQe,cAAc,CAACC,IAAI,CACnD,CAACpB,WAAaA,SAASC,IAAI,KAAKW;QAGjC,IAAI,CAACK,kBAAkB;YACtB,OAAO;gBACNP,MAAM;YACP;QACD;QAEA,MAAMW,yBAAyB,MAAMJ,iBAAiBf,YAAY,CAACC;QAEnE,IAAIkB,uBAAuBX,IAAI,EAAEY,OAAOX,QAAQ;YAC/C,OAAO;gBACND,MAAM;oBACL,GAAGW,uBAAuBX,IAAI;oBAC9Ba,WAAW;gBACZ;YACD;QACD,OAAO;YACN,OAAO;gBACNb,MAAM;YACP;QACD;IACD;AACD,EAAC"}